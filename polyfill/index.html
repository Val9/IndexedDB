<html>
    <head>
        <title>Testing IndexedDB Shim</title>
        <link rel="stylesheet" href="/qunit/qunit.css" type="text/css" media="screen" />
        <script type="text/javascript" src="/qunit/qunit.js">
        </script>
        <script type = "text/javascript">
            function _(msg){
            	console.log("[" + QUnit.config.current.module + ":" + QUnit.config.current.testName + "]", msg, arguments.callee.caller.arguments);
            }
        </script>
        <script type = "text/javascript" src= "sampleData.js">
        </script>
        <script type = "text/javascript" src= "src/build.js">
        </script>
        <script type = "text/javascript">
            function startTests(){
            	buildIndexedDB(runTests);
            }
            
            function deleteDB(callback){
            	var deleteReq = window.indexedDB.deleteDatabase(DB.NAME);
            	deleteReq.onsuccess = function(){
            		console.log("Database deleted");
            		callback();
            	};
            	deleteReq.onerror = function(e){
            		console.log("Could not delete database");
            		callback();
            	};
            }
            
            function runTests(){
            	console.log("Starting Tests");
            	deleteDB(startQUnitTests);
            };
            
            function startQUnitTests(){
            	var dbVersion = 1;
            	module("Database");
            	asyncTest("Opening a Database without version", function(){
            		var dbOpenRequest = window.indexedDB.open(DB.NAME);
            		dbOpenRequest.onsuccess = function(e){
            			ok(true, "Database Opened successfully");
            			_("Database opened successfully");
            			start();
            		};
            		dbOpenRequest.onerror = function(e){
            			ok(false, "Database NOT Opened successfully");
            			_("Database NOT opened successfully");
            			start();
            		};
            		dbOpenRequest.onupgradeneeded = function(e){
            			ok(false, "Database upgrade should not be called");
            			_("Database upgrade called");
            			start();
            			stop();
            		};
            	});
            	
            	asyncTest("Opening a database with a version", function(){
            		var dbOpenRequest = window.indexedDB.open(DB.NAME, ++dbVersion);
            		dbOpenRequest.onsuccess = function(e){
            			ok(true, "Database Opened successfully");
            			_("Database opened successfully with version");
            			start();
            		};
            		dbOpenRequest.onerror = function(e){
            			ok(false, "Database NOT Opened successfully");
            			_("Database NOT opened successfully");
            			start();
            		};
            		dbOpenRequest.onupgradeneeded = function(e){
            			ok(true, "Database Upgraded successfully");
            			_("Database upgrade called");
            		};
            	});
            	
            	module("Object Store");
            	asyncTest("Creating an Object Store", function(){
            		var dbOpenRequest = window.indexedDB.open(DB.NAME, ++dbVersion);
            		dbOpenRequest.onsuccess = function(e){
            			ok(true, "Database Opened successfully");
            			_("Database opened successfully with version");
            			start();
            		};
            		dbOpenRequest.onerror = function(e){
            			ok(false, "Database NOT Opened successfully");
            			_("Database NOT opened successfully");
            			start();
            		};
            		dbOpenRequest.onupgradeneeded = function(e){
            			ok(true, "Database Upgraded successfully");
            			_("Database upgrade called");
            			var db = dbOpenRequest.result;
            			db.createObjectStore(DB.OBJECT_STORE_1);
            			db.createObjectStore(DB.OBJECT_STORE_2, {
            				"keyPath": "id",
            				"autoIncrement": true
            			});
            			db.createObjectStore(DB.OBJECT_STORE_3, {
            				"autoIncrement": true
            			});
            			db.createObjectStore(DB.OBJECT_STORE_4, {
            				"keyPath": "id"
            			});
            			equal(db.objectStoreNames.length, 4, "Count of Object Stores created is correct");
            			_(db.objectStoreNames);
            			start();
            			stop();
            		};
            	});
            	
            	asyncTest("Deleting an Object Store", function(){
            		var dbOpenRequest = window.indexedDB.open(DB.NAME, ++dbVersion);
            		dbOpenRequest.onsuccess = function(e){
            			ok(true, "Database Opened successfully");
            			_("Database opened successfully with version");
            			start();
            		};
            		dbOpenRequest.onerror = function(e){
            			ok(false, "Database NOT Opened successfully");
            			_("Database NOT opened successfully");
            			start();
            		};
            		dbOpenRequest.onupgradeneeded = function(e){
            			ok(true, "Database Upgraded successfully, now trying to delete the database");
            			_("Database upgrade called");
            			var db = dbOpenRequest.result;
            			var len = db.objectStoreNames.length;
            			db.createObjectStore(DB.OBJECT_STORE_4, {
            				"keyPath": "id"
            			});
            			db.deleteObjectStore(DB.OBJECT_STORE_4);
            			equal(db.objectStoreNames.indexOf(DB.OBJECT_STORE_4), -1, "Database does not contain Object Store 4");
            			start();
            			stop();
            		};
            	});
            };
        </script>
    </head>
    <body onload ="startTests()">
        <h1 id="qunit-header">Jquery IndexedDB Tests</h1>
        <h2 id="qunit-banner"></h2>
        <div id="qunit-testrunner-toolbar">
        </div>
        <h2 id="qunit-userAgent"></h2>
        <ol id="qunit-tests">
        </ol>
        <div id="qunit-fixture">
            test markup, will be hidden
        </div>
    </body>
</html>
